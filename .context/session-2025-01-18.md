# Podcast Framework Development Session - 2025-01-18

## Session Summary

This session focused on fixing critical bugs in the CLI package following the v0.1.17 release. We addressed template literal escaping issues and improved the RSS importer functionality.

### Versions Published This Session

- **CLI v0.1.18** - Partial fix for template literal escaping (incomplete)
- **CLI v0.1.19** - Complete fix for all template literal escaping issues
- **CLI v0.1.20** - Added RSS feed URL saving to podcast document

Current stable versions:
- `@rejected-media/podcast-framework-cli`: **0.1.20**
- `@rejected-media/podcast-framework-core`: **0.1.2**
- `@rejected-media/podcast-framework-sanity-schema`: **1.1.0**

---

## Issues Fixed This Session

### Issue 1: Template Literal Escaping (v0.1.18 - v0.1.19)

**Problem**: The contribute.astro template (and all other page templates) had incorrectly triple-escaped backticks (`\\\``) and dollar signs (`\\\${`) in JavaScript template literals, causing esbuild parse errors that prevented the dev server from starting.

**Root Cause**: When generating Astro page templates as TypeScript template strings, the backticks and dollar signs needed single-escaping (`\``) not triple-escaping (`\\\``).

**Solution**:
- v0.1.18: Fixed first batch of escaped backticks (4-5 instances) - **incomplete**
- v0.1.19: Fixed ALL 44+ remaining instances using sed replacement

**Files Changed**:
- `/packages/cli/src/commands/create.ts` - All page template strings (lines 317-2047)

**Fix Applied**:
```bash
sed -i '' 's/\\\\\\\`/\\`/g' create.ts   # Triple-escaped → single-escaped backticks
sed -i '' 's/\\\\\\\$/\\$/g' create.ts   # Triple-escaped → single-escaped dollar signs
```

**Manual Fix Required**: One template literal at line 2036-2040 needed manual correction because it uses conditional logic.

**Lesson Learned**: When doing template string escaping fixes, use global search/replace to catch ALL instances, not just the first few.

### Issue 2: RSS Feed URL Not Saved (v0.1.20)

**Problem**: The RSS import command took the feed URL as input but didn't save it to the podcast document in Sanity CMS. This meant users had to manually add a URL they'd already provided.

**Impact**:
- Subscribe sections couldn't automatically show RSS feed links
- Inconsistent UX - framework knew the RSS URL but didn't save it
- Extra manual step for users after import

**Solution**: Added one line to podcast document creation in sanity-importer.ts:

```typescript
const podcastDoc = {
  _type: 'podcast',
  name: show.title,
  tagline: '',
  description: show.description,
  logo: logoImage,
  isActive: true,
  rssUrl: this.options.feedUrl, // ← Added this line
};
```

**Files Changed**:
- `/packages/cli/src/lib/rss-import/sanity-importer.ts` - Line 66

**Benefit**: RSS feed URL now automatically populates in Sanity CMS and can appear in subscribe sections on the website.

---

## Project Structure

### Monorepo Layout

```
podcast-framework-project/
├── podcast-framework/                    # Main monorepo (npm packages)
│   ├── packages/
│   │   ├── cli/                         # @rejected-media/podcast-framework-cli
│   │   │   ├── src/commands/create.ts   # Project scaffolding (CRITICAL FILE)
│   │   │   ├── src/lib/rss-import/      # RSS import functionality
│   │   │   └── package.json             # CLI package config
│   │   ├── core/                        # @rejected-media/podcast-framework-core
│   │   │   ├── src/components/          # Framework components
│   │   │   ├── src/layouts/             # BaseLayout
│   │   │   ├── src/lib/                 # Utilities, helpers, types
│   │   │   └── package.json
│   │   └── sanity-schema/               # @rejected-media/podcast-framework-sanity-schema
│   │       ├── src/schemas/             # Sanity CMS schemas
│   │       └── package.json
│   └── .context/                        # Session notes & development context
│
├── podcast-framework-docs/              # Documentation site
│   └── src/content/docs/
│       └── getting-started/
│           ├── installation.md          # Package version references
│           └── project-structure.md     # Package version references
│
├── podcast-template/                    # Template repository (used by CLI)
│   └── (This is what CLI generates)
│
└── podcasts/
    └── strange-water/                   # Production reference implementation
        └── src/pages/                   # Source of truth for all page templates
```

### Key Repositories

1. **podcast-framework** (Main monorepo)
   - GitHub: `https://github.com/rejected-media/podcast-framework.git`
   - Contains: CLI, Core, Sanity Schema packages
   - Branch: `main`

2. **podcast-framework-docs** (Documentation)
   - GitHub: `https://github.com/rejected-media/podcast-framework-docs.git`
   - Contains: User-facing documentation
   - Branch: `main`

3. **podcast-template** (Template repo)
   - GitHub: `https://github.com/rejected-media/podcast-template`
   - Used by: GitHub template feature
   - Note: CLI generates projects programmatically, doesn't clone this

4. **strange-water** (Reference implementation)
   - Location: `~/coding/rejected-media/podcasts/strange-water`
   - Purpose: Production podcast website
   - **IMPORTANT**: Source of truth for all page templates

---

## Critical Development Principles

### 1. Version Numbering
**RULE**: Do NOT graduate any package to version 1.0.0 without explicit user approval.

Current versioning:
- CLI: 0.1.x (currently 0.1.20)
- Core: 0.1.x (currently 0.1.2)
- Sanity Schema: 1.1.x (currently 1.1.0)

### 2. Template Philosophy
**RULE**: All page templates generated by the CLI must be EXACT copies of Strange Water production templates, not simplified versions.

The framework's purpose is to allow people to deploy the exact same website as strangewater.xyz for other podcasts, with the only differences coming from CMS content.

**Source of Truth**: `~/coding/rejected-media/podcasts/strange-water/src/pages/`

**Generated Templates Include**:
- `index.astro` - CMS-driven homepage with hero, featured carousel
- `episodes/index.astro` - Episode list with search, sort
- `episodes/[slug].astro` - Episode detail (279 lines) with TranscriptViewer
- `guests/index.astro` - Guest directory with grid layout
- `guest/[slug].astro` - Guest profile with social links
- `about.astro` - About page (335 lines, CMS-driven)
- `contribute.astro` - Contribution form (437 lines, interactive)
- `api/contribute.ts` - Contribution API with rate limiting
- `api/newsletter-subscribe.ts` - Newsletter subscription API

### 3. Package Publishing Workflow

When publishing a package update:

1. **Make code changes**
2. **Update package.json version**
3. **Build the package**
   ```bash
   cd packages/cli  # or core, or sanity-schema
   npm run build
   ```
4. **Publish to npm**
   ```bash
   npm publish
   ```
5. **Commit and push to GitHub**
   ```bash
   git add .
   git commit -m "Fix: description of fix"
   git push
   ```
6. **Update documentation** (if version changed)
   - Update `installation.md` package versions
   - Update `project-structure.md` package versions
   - Commit and push docs repo

### 4. Git Commit Message Format

Use this format for all commits:

```
Fix CLI vX.X.X: Brief description

CRITICAL/IMPROVEMENT/FEATURE:
- Bullet point explanation
- What changed and why
- Impact on users

Changes:
- Specific file changes
- Line numbers if applicable

🤖 Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>
```

### 5. Template String Escaping Rules

When working with page templates in `create.ts`:

- **Outer level**: TypeScript template string using backticks
- **Inner level**: Astro/JavaScript code that may contain template literals
- **Escaping**: Use `\`` and `\$` for inner template literals
- **Never use**: `\\\`` or `\\\$` (triple-escaped)

Example:
```typescript
const contributePage = `
<script>
  const message = \`Hello \${name}\`;  // ← Single-escaped (correct)
  // NOT: const message = \\\`Hello \\\${name}\\\`;  // ← Triple-escaped (wrong)
</script>
`;
```

---

## File Locations Reference

### Critical Files

1. **CLI Project Generator**
   - Path: `/packages/cli/src/commands/create.ts`
   - Lines: ~2400 lines
   - Contains: All page template strings, project scaffolding logic
   - **Most Important File**: This generates everything users get when running `npm create @rejected-media/podcast-framework`

2. **RSS Importer**
   - Path: `/packages/cli/src/lib/rss-import/sanity-importer.ts`
   - Purpose: Imports RSS feed data into Sanity CMS
   - Key Method: `importShow()` - Creates/updates podcast document

3. **Podcast Schema**
   - Path: `/packages/sanity-schema/src/schemas/podcast.ts`
   - Contains: Sanity schema for podcast metadata
   - Fields: name, tagline, description, logo, rssUrl, platform URLs, social links

4. **Core Package Main Export**
   - Path: `/packages/core/src/index.ts`
   - Exports: All utilities, helpers, components, types

5. **Documentation Files**
   - Path: `/podcast-framework-docs/src/content/docs/getting-started/`
   - Files: `installation.md`, `project-structure.md`
   - Update when: CLI version changes

---

## Common Development Workflows

### Fixing a Bug in Generated Templates

1. **Identify the issue** in user feedback
2. **Find the template** in `/packages/cli/src/commands/create.ts`
3. **Check Strange Water** for correct implementation
4. **Update the template string** in create.ts
5. **Bump CLI version** in package.json
6. **Build and publish CLI**
7. **Update documentation** with new version
8. **Test** by creating a new project with the CLI

### Adding a New Feature to Core

1. **Implement in core package** (`/packages/core/src/`)
2. **Update TypeScript types** if needed
3. **Bump core version** in package.json
4. **Build and publish core**
5. **Update CLI templates** if they need to use the feature
6. **Update documentation** with examples

### Updating Documentation Only

1. **Make changes** to markdown files
2. **Commit and push** to docs repo
3. **No package publishing** needed

---

## Environment Setup

### Required Tools
- Node.js 18+
- npm 9+
- Git

### Package Manager
- Use `npm` (not pnpm or yarn) for consistency

### Working Directories
- Framework: `/Users/rexkirshner/coding/rejected-media/podcast-framework-project/podcast-framework`
- Docs: `/Users/rexkirshner/coding/rejected-media/podcast-framework-project/podcast-framework-docs`
- Strange Water: `/Users/rexkirshner/coding/rejected-media/podcasts/strange-water`

---

## Common Issues and Solutions

### Build Errors in CLI

**Symptom**: esbuild syntax errors when running `npm run build`

**Common Causes**:
1. Incorrect template string escaping
2. Unclosed template literals
3. JavaScript syntax errors in template strings

**Solution**:
- Check template strings in create.ts for proper escaping
- Use `\`` and `\$` for inner template literals
- Test by creating a project and running dev server

### Template Generates Invalid Code

**Symptom**: Generated project has syntax errors

**Root Cause**: Template strings in create.ts have incorrect escaping

**Solution**:
1. Find the problematic template in create.ts
2. Check escaping rules (use `\`` not `\\\``)
3. Rebuild and republish CLI

### Documentation Out of Sync

**Symptom**: Docs reference old package versions

**Solution**:
1. Update `installation.md` package versions section
2. Update `project-structure.md` dependencies example
3. Commit and push docs repo

---

## Testing Checklist

Before publishing a CLI update:

- [ ] Build succeeds (`npm run build`)
- [ ] Create a test project: `npm create @rejected-media/podcast-framework test-project`
- [ ] Test project installs dependencies successfully
- [ ] Test project runs dev server: `npm run dev`
- [ ] Test project builds: `npm run build`
- [ ] Check generated pages render correctly
- [ ] Check Sanity Studio works: `npm run dev:sanity`
- [ ] Test RSS import (if changed): `npm run import:episodes`

---

## Recent History (v0.1.9 - v0.1.20)

This provides context for the progression of fixes:

1. **v0.1.9** - Added missing CLI dependency to template
2. **v0.1.10** - Fixed wrong package names (@podcast-framework/* → @rejected-media/*)
3. **v0.1.11** - Made homepage dynamic (was showing hardcoded data)
4. **v0.1.12** - Added missing resend dependency
5. **v0.1.13** - (skipped)
6. **v0.1.14** - Fixed null theme crashes in core v0.1.2
7. **v0.1.15** - Added missing Tailwind CSS
8. **v0.1.16** - Added missing essential pages
9. **v0.1.17** - Replaced ALL templates with exact Strange Water production versions
10. **v0.1.18** - Partial fix for template literal escaping (incomplete)
11. **v0.1.19** - Complete fix for template literal escaping (all 44+ instances)
12. **v0.1.20** - RSS importer now saves feed URL to podcast document

### Pattern Recognition

The v0.1.9-v0.1.17 sequence showed a pattern of missing production-quality features. Each release was addressing user feedback about gaps between what the CLI generated and what a real podcast website needs.

The v0.1.17 release was a major milestone - replacing all simplified templates with exact Strange Water production templates. This aligned the framework with its core purpose.

The v0.1.18-v0.1.19 sequence showed the importance of thorough global replacements. v0.1.18 only fixed a few instances, while v0.1.19 used sed to fix all 44+ instances at once.

---

## Next Session Preparation

### Current State (2025-01-18 End of Session)

✅ **All Critical Bugs Fixed**
- Template literal escaping: RESOLVED (v0.1.19)
- RSS feed URL saving: RESOLVED (v0.1.20)
- All packages published and documented

✅ **All Repositories Up to Date**
- podcast-framework: main branch pushed
- podcast-framework-docs: main branch pushed
- All npm packages published

✅ **No Known Blockers**
- Users can successfully create projects
- Dev servers start without errors
- RSS import works and saves feed URL

### Areas That May Need Attention

1. **User Feedback Monitoring**
   - Watch for new issues from users testing the framework
   - Common patterns: missing dependencies, configuration errors, template bugs

2. **Template Refinements**
   - Templates are now exact Strange Water copies
   - May need tweaks based on specific user needs
   - Keep Strange Water as source of truth

3. **Feature Additions**
   - New components or utilities
   - Enhanced RSS import features
   - Additional page templates

4. **Documentation Improvements**
   - More examples
   - Troubleshooting guides
   - Video tutorials

### How to Resume Next Session

1. **Read this document** to restore context
2. **Check current versions**:
   ```bash
   cd podcast-framework/packages/cli
   cat package.json | grep version
   ```
3. **Pull latest changes**:
   ```bash
   git pull
   ```
4. **Review any new user feedback** or GitHub issues
5. **Continue from where we left off**

---

## Quick Reference Commands

### Navigate to Projects
```bash
cd ~/coding/rejected-media/podcast-framework-project/podcast-framework
cd ~/coding/rejected-media/podcast-framework-project/podcast-framework-docs
cd ~/coding/rejected-media/podcasts/strange-water
```

### Build CLI Package
```bash
cd ~/coding/rejected-media/podcast-framework-project/podcast-framework/packages/cli
npm run build
```

### Publish CLI Package
```bash
npm publish
```

### Test CLI Locally
```bash
npm create @rejected-media/podcast-framework test-project
cd test-project
npm install
npm run dev
```

### Update Documentation
```bash
cd ~/coding/rejected-media/podcast-framework-project/podcast-framework-docs
# Edit files
git add -A
git commit -m "Update docs"
git push
```

### Check Published Versions
```bash
npm view @rejected-media/podcast-framework-cli version
npm view @rejected-media/podcast-framework-core version
npm view @rejected-media/podcast-framework-sanity-schema version
```

---

## Important Notes

- **Always reference Strange Water** for template correctness
- **Never skip documentation updates** when versions change
- **Test generated projects** before publishing CLI updates
- **Keep version numbers below 1.0.0** without explicit approval
- **Use exact production templates** not simplified versions
- **Save this document** for context between sessions

---

**Document Created**: 2025-01-18
**Last Updated**: 2025-01-18
**CLI Version**: 0.1.20
**Core Version**: 0.1.2
**Sanity Schema Version**: 1.1.0
**Status**: Ready for next session
